{% load custom_filters %}
{% include "head.html" %}
{% load static %}

{% include 'PolicyAndMinistries/include/head.html' %}
<style>
    .scrollable {
        max-height: 700px;
        /* replace 500px with your desired maximum width */
        overflow-y: auto;
        /* enable 
    horizontal scrolling */
    }


    .vertical-text {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        text-orientation: sideways-right;
        white-space: nowrap;
        width: 100%;
        text-align: center;
    }


</style>


<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">

        <!-- Preloader -->
        {% include "navbar.html" %}
        {% include "sidebar.html" %}
        
        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
          <!-- Content Header (Page header) -->
          <div class="content-header">
            <div class="container">
              <div class="row mb-2">

                <div class="col-sm-6">
                    <h1 class="m-0">Notifier</h1>
                </div>
                
                <!-- /.col -->
                <div class="pc-container">      
                    <div class="row " style="min-height: 520px;">
                        <div class="col-md-5 p-2 card scrollable" style="min-height: 520px;">
                            <!--Ministries Lists-->
                            <div class=" p-2 justify-content-center">
                                <div class="card-body row p-0 mt-3">
                                    <div class="col-md-12">
                            
                                            <div class="form-group m-3">
                                                <label>Ministries</label>
                                                <div class="mb-3">
                                                    <button type="button" id="btn-addall" class="btn btn-sm btn-success">Select all</button>
                                                    <button type="button" id="btn-clearall" class="btn btn-sm btn-success">Clear</button>
                                                </div>
                                                <select class="select2 form-control" id="multiSelect" name="selected_ministries[]" multiple="multiple"
                                                    data-placeholder="Select a Ministry">

                                                    {% for ministry in ministries %}
                                                        <option  value="{{ ministry.id }}">
                                                            {{ ministry.responsible_ministry_eng }}
                                                        </option>
                                                    {% endfor %}

                                                </select>
                                
                                            </div>
                                
                                    </div>
                                
                                </div>
                            </div>
                        </div>
                        <div class="col-md-7 p-2  card scrollable">

                            <div class="card-body pc-component">
                                <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                                    <li class="nav-item" role="presentation"><a class="nav-link text-uppercase active" id="home-tab" data-bs-toggle="tab"
                                            href="#home" role="tab" aria-controls="home" aria-selected="false" tabindex="-1">Preset</a></li>
                                    <li class="nav-item" role="presentation"><a class="nav-link text-dark text-uppercase" id="profile-tab"
                                            data-bs-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="true">Custom</a>
                                    </li>
                                </ul>
                                <div class="tab-content" id="myTabContent">
                                    <div class="tab-pane fade active show" id="home" role="tabpanel" aria-labelledby="home-tab">
                                            <div class="row p-3 justify-content-center">

                                                {% for i in "1234"|slice:":" %} 
                                                <div class="col-xl-6"  name="preset_card" >
                                                    <div class="card border card-shadow p-2 m-2">
                                                        <div class="row ">
                                                            <div class="col-6 rounded-start rounded-start">
                                                                <div class="row justify-content-center  text-white">
                                                                    <img class="img-fluid" src="{% static 'icons/Push notifications.gif'%}" alt="">
                                                                </div>
                                                            </div>
                                            
                                                            <div class="col-6 align-items-center d-flex">
                                                                <p class="fw-bold">Notify to enter Performance</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            

                                            </div>
                                    </div>
                                    <div class="tab-pane fade " id="profile" role="tabpanel" aria-labelledby="profile-tab">
                                       <div class="mt-4">
                                        <div class="alert alert-light border border-info" role="alert">
                                        To dynamically display the ministry name, use the keyword <span class="fw-bold text-success">$MINISTRY_NAME</span>. 
                                        <p class="mt-3">For example:"Dear <span class="fw-bold text-success">$MINISTRY_NAME</span>, your request has been processed."</p>
                                        </div>

                                        <form id="form_custom_email" method="post">
                                             <div id="responseMessage" class="mt-3"></div>
                                            <label for="subject">Subject</label>
                                            <input type="text" name="subject" id="subject" required class="form-control mb-2" placeholder="Enter subject" />
                                            
                                            <label for="">Message</label>

                                            <textarea va class="form-control" required name="message" id="message" cols="30" rows="10" placeholder="Enter your message"></textarea>

                                            <div class="mt-1 text-right">
                                                <button  name="btn-loading" class="btn btn-success lh-1" style="display: none;" type="button" disabled="disabled"><span class="spinner-border spinner-border-sm" role="status"></span> Loading...</button>
                                                <button name="btn-submit" type="submit" class="btn btn-success">Save changes</button>
                                            </div>
                                        </form>


                                       </div>
                                    </div>


                                </div>
                            </div>

                            
                        </div>
                    </div>
                    
                </div>
                

            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Send Notification</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <h4>Seleccted Ministries</h4>
                {% for ministry in ministries %}
                   <span name="selected_ministry" data-id="{{ministry.id}}" class="badge bg-secondary">{{ministry.code}}</span>
                {% endfor %}


                <div class="mt-5 row">
                    <label class="col-sm-2 text-sm-end col-form-label">Language</label>
    
                    <div class="col-sm-3">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="group4" value="" id="flexCheckDefault">
                            <label class="form-check-label" for="flexCheckDefault">Amharic</label>
                        </div>
                    
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="group4" value="" id="flexCheckChecked" checked="checked">
                            <label class="form-check-label" for="flexCheckChecked">English</label>
                        </div>
                    </div>
                </div>

                <h4 class="mt-5">Sample Email</h4>
                <p>We are pleased to announce that the Performance Entry Portal is now open! This is your opportunity to record and submit
                  performance data for the [specify period, e.g., Q4 2024 or Annual Review].
                </p>

                

                
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button  name="btn-loading" class="btn btn-success lh-1" style="display: none;" type="button" disabled="disabled"><span class="spinner-border spinner-border-sm" role="status"></span> Loading...</button>
             <button name="btn-submit" type="submit" class="btn btn-success">Save changes</button>
          </div>
        </div>
      </div>
    </div>


</body>



{% include "footer.html" %}
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>


<script>
    $(document).ready(function () {
        // Initialize Choices.js
         const choices = new Choices('#multiSelect', {
           removeItemButton: true,
           searchEnabled: true, // Enables search functionality
         });
     

        // Select all options on button click
        $('#btn-addall').on('click', function () {
            const allOptions = $('#multiSelect option');
            allOptions.each(function () {
                const value = $(this).val();
                choices.setChoiceByValue(value); // Set choice as selected by value
            });
        });

        // Clear all options on button click
        $('#btn-clearall').on('click', function () {
            choices.removeActiveItems(); // Remove all selected items using Choices.js API
        });

        // Handle form submission with custom validation
        $('#form_custom_email').on('submit', function (e) {
            e.preventDefault(); // Prevent default form submission


            // Get the textarea value
            const message = $('#message').val();
            const selectedMinistry = choices.getValue(true);
            const subject = $('#subject').val();



            // Validate input
            if (!message.trim()) {
                alert('Message cannot be empty.');
                return;
            }

            if(!subject.trim()){
                alert('Subject cannot be empty.');
                return;
            }

            if(selectedMinistry.length == 0){
                alert('Please select at least one ministry to proceed.');
                return;
            }

            $.ajax({
                url: '{% url 'notifier' %}', // Replace with your backend endpoint
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'  // add CSRF token to headers
                },
                data: {
                    form_custom : 'form_custom' ,
                    subject : subject,
                    message: message,
                    ministries: selectedMinistry
                 },
                beforeSend: function() {
                    $("[name='btn-submit']").hide()
                    $("[name='btn-loading']").show();
                },
                // hides the loader after completion of request, whether successfull or failor.             
                complete: function() {
                    //Show save button finished 
                    $("[name='btn-submit']").show()
                    $("[name='btn-loading']").hide();
                },
                success: function (response) {
                    // Handle success (e.g., show a confirmation message)
                   if(response.success){
                        $('#responseMessage').html('<div class="alert alert-success alert-dismissible fade show" role="alert">Message sent successfully! <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                        $('#message').val('')
                        $('#subject').val('')
                        choices.removeActiveItems();
                   }else{
                    $('#responseMessage').html(`<div class="alert alert-danger alert-dismissible fade show" role="alert">${response.message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`);
                   }
                },
                error: function () {
                    // Handle error (e.g., show an error message)
                    $('#responseMessage').html('<div class="alert alert-danger">Failed to send message. Please try again.</div>');
                }
            });

        });


        //handle Modal 
        $("[name='preset_card']").on('click', function(){
            const selectedMinistry = choices.getValue(true);
            const ministryLists = $("[name='selected_ministry']")

            if(selectedMinistry.length == 0){
                alert('Please select at least one ministry to proceed.');
            }else{
                 $('#exampleModal').modal('show');
            }

            ministryLists.each(function () {
                const ministryId = $(this).data('id'); // Assuming each ministry has a `data-id` attribute

 
                // Check if the current ministry ID matches the selected ID(s)
                if (selectedMinistry.includes(`${ministryId}`)) {
                    $(this).removeClass('d-none')
                } else {
                    $(this).addClass('d-none');
                }
            });

        })

    });
</script>


</html>



     